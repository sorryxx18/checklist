<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>消防訓練安全檢核系統 (Pro)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- 外部資源 -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root { --primary: #d32f2f; --secondary: #263238; --bg: #eceff1; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        
        .step-container { max-width: 850px; margin: 20px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .header { text-align: center; border-bottom: 3px solid var(--primary); margin-bottom: 25px; padding-bottom: 10px; }
        
        /* 進度條 */
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .p-step { flex: 1; text-align: center; border-bottom: 4px solid #cfd8dc; padding-bottom: 8px; color: #90a4ae; font-weight: bold; }
        .p-step.active { color: var(--primary); border-color: var(--primary); }

        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 表單與表格 */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 6px; font-size: 0.95rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f5f5f5; padding: 12px; border: 1px solid #e0e0e0; }
        td { padding: 10px; border: 1px solid #e0e0e0; text-align: center; }

        /* 簽名板 */
        .sig-wrapper { margin-top: 20px; border: 2px dashed #b0bec5; border-radius: 8px; background: #fff; position: relative; }
        canvas { width: 100%; height: 200px; touch-action: none; cursor: crosshair; }
        .sig-hint { position: absolute; top: 10px; left: 10px; color: #cfd8dc; pointer-events: none; }

        /* 按鈕控制 */
        .btn-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: 0.3s; }
        .btn-gray { background: #b0bec5; color: white; }
        .btn-red { background: var(--primary); color: white; }
        .btn-blue { background: #1976d2; color: white; }
        .btn:hover { filter: brightness(0.9); }

        /* Loading */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; flex-direction: column; justify-content: center; align-items: center; }
        
        /* 預覽 Modal */
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; padding: 20px; box-sizing: border-box; }
        .modal-body { background:white; width:100%; height:100%; border-radius:8px; display:flex; flex-direction:column; }
        iframe { flex:1; border:none; }
    </style>
</head>
<body>

<div id="loader">
    <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary)"></i>
    <p style="margin-top:20px; font-weight:bold;">正在執行數位歸檔程序...</p>
</div>

<div class="step-container">
    <div class="header">
        <h2>消防訓練安全檢核系統</h2>
    </div>

    <div class="progress-bar">
        <div class="p-step active" id="p1">1. 基本資料</div>
        <div class="p-step" id="p2">2. 項目核對</div>
        <div class="p-step" id="p3">3. 簽名確認</div>
    </div>

    <!-- Step 1 -->
    <div class="step active" id="step1">
        <div class="input-grid">
            <div style="grid-column: span 2;">
                <label>訓練名稱</label>
                <input type="text" id="tName" placeholder="例如：113年救助隊複訓">
            </div>
            <div>
                <label>訓練日期與時間</label>
                <input type="datetime-local" id="tTime">
            </div>
            <div>
                <label>訓練地點</label>
                <input type="text" id="tLoc" placeholder="輸入地點">
            </div>
            <div style="grid-column: span 2;">
                <label>通知 Email (成果將寄送至此)</label>
                <input type="email" id="tEmail" placeholder="officer@fire.gov.tw">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-red" onclick="goStep(2)">下一步：核對項目 <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- Step 2 -->
    <div class="step" id="step2">
        <table>
            <thead>
                <tr><th width="10%">項次</th><th>安全檢查事項</th><th width="30%">判定</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div style="margin-top:15px;">
            <label>待改進或檢修事項說明</label>
            <textarea id="tMemo" rows="3" placeholder="若有「否」之項目請說明..."></textarea>
        </div>
        <div class="btn-group">
            <button class="btn btn-gray" onclick="goStep(1)">上一步</button>
            <button class="btn btn-red" onclick="goStep(3)">下一步：簽名 <i class="fas fa-pen-nib"></i></button>
        </div>
    </div>

    <!-- Step 3 -->
    <div class="step" id="step3">
        <label>教官簽章</label>
        <div class="sig-wrapper">
            <span class="sig-hint">請手寫簽名</span>
            <canvas id="cInst"></canvas>
        </div>
        <button onclick="pInst.clear()" style="margin: 5px 0 20px;">清除重簽</button>

        <label>當日安全官簽章</label>
        <div class="sig-wrapper">
            <span class="sig-hint">請手寫簽名</span>
            <canvas id="cSafe"></canvas>
        </div>
        <button onclick="pSafe.clear()" style="margin-top:5px;">清除重簽</button>

        <div class="btn-group">
            <button class="btn btn-gray" onclick="goStep(2)">上一步</button>
            <button class="btn btn-blue" onclick="openPreview()">預覽 PDF</button>
            <button class="btn btn-red" style="background:#2e7d32;" onclick="finalSubmit()">確認並上傳歸檔 <i class="fas fa-cloud-upload-alt"></i></button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-body">
        <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;">
            <h3 style="margin:0;">PDF 預覽</h3>
            <button onclick="closeModal()">關閉</button>
        </div>
        <iframe id="pdfFrame"></iframe>
    </div>
</div>

<script>
    // ⚠️ 修正：請填入您的 GAS 部署網址
    const WEB_APP_URL = "您的_GAS_網址";

    const items = [
        "於訓練前是否有對學員進行危害告知?",
        "是否依照消防署或局頒教材內容安排進行上課。",
        "是否已熟知署頒消防安全救災手冊相關規定？",
        "現場操作人員有無身體不適情形？醫療器材有無準備？",
        "評估天候狀況是否適合操作?",
        "是否選用適當操作場域?",
        "個人裝備及使用器材是否適當?",
        "訓練所需裝備器材外觀功能點檢是否正常?",
        "確認操作人員個人裝備及身體狀況",
        "教官是否進行示範講解",
        "是否有擬定安全計畫(備援方案)？"
    ];

    let pInst, pSafe;

    window.onload = () => {
        const tbody = document.getElementById('tableBody');
        items.forEach((text, i) => {
            tbody.innerHTML += `<tr><td>${i+1}</td><td style="text-align:left">${text}</td>
                <td><select id="check_${i}"><option value="是">是</option><option value="否">否</option><option value="N/A">N/A</option></select></td></tr>`;
        });
        document.getElementById('tTime').value = new Date().toISOString().slice(0, 16);
        initSign();
    };

    function initSign() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        [document.getElementById('cInst'), document.getElementById('cSafe')].forEach(canvas => {
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        });
        pInst = new SignaturePad(document.getElementById('cInst'));
        pSafe = new SignaturePad(document.getElementById('cSafe'));
    }

    function goStep(n) {
        if (n === 2 && !document.getElementById('tName').value) { alert("請填寫訓練名稱"); return; }
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.p-step').forEach(p => p.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        for(let i=1; i<=n; i++) document.getElementById('p'+i).classList.add('active');
        if (n === 3) setTimeout(initSign, 200);
    }

    async function getPDFBlob() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const hiddenDiv = document.createElement('div');
        hiddenDiv.style.cssText = "position:fixed; left:-9999px; width:750px; padding:40px; background:white; color:black;";
        
        let rows = "";
        items.forEach((txt, i) => {
            rows += `<tr><td style="border:1px solid #000; padding:8px; text-align:center;">${i+1}</td>
                <td style="border:1px solid #000; padding:8px;">${txt}</td>
                <td style="border:1px solid #000; padding:8px; text-align:center;">${document.getElementById('check_'+i).value}</td></tr>`;
        });

        hiddenDiv.innerHTML = `
            <h1 style="text-align:center;">臺北市政府消防局</h1>
            <h2 style="text-align:center; margin-top:-10px;">訓練安全檢核表 (通用)</h2>
            <div style="margin:20px 0; line-height:1.8;">
                <b>名稱：</b>${document.getElementById('tName').value}<br>
                <b>時間：</b>${document.getElementById('tTime').value.replace('T',' ')}<br>
                <b>地點：</b>${document.getElementById('tLoc').value}
            </div>
            <table style="width:100%; border-collapse:collapse; border:1px solid #000;">
                <thead><tr style="background:#eee;"><th>項次</th><th>檢查注意事項</th><th>判定</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
            <p><b>備註/說明：</b>${document.getElementById('tMemo').value || "無"}</p>
            <div style="display:flex; margin-top:30px;">
                <div style="flex:1">教官簽章：<br><img src="${pInst.toDataURL()}" style="width:180px; border-bottom:1px solid #000"></div>
                <div style="flex:1">安全官簽章：<br><img src="${pSafe.toDataURL()}" style="width:180px; border-bottom:1px solid #000"></div>
            </div>
        `;
        document.body.appendChild(hiddenDiv);
        const canvas = await html2canvas(hiddenDiv, { scale: 2 });
        document.body.removeChild(hiddenDiv);
        pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 210, (canvas.height * 210) / canvas.width);
        return pdf.output('blob');
    }

    async function openPreview() {
        if(pInst.isEmpty() || pSafe.isEmpty()) { alert("請完成雙方簽名"); return; }
        const blob = await getPDFBlob();
        document.getElementById('pdfFrame').src = URL.createObjectURL(blob);
        document.getElementById('modal').style.display = 'block';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function finalSubmit() {
        if(pInst.isEmpty() || pSafe.isEmpty()) { alert("請完成雙方簽名"); return; }
        if(!confirm("確定內容正確並送出歸檔？")) return;

        document.getElementById('loader').style.display = 'flex';
        
        try {
            const blob = await getPDFBlob();
            const base64 = await new Promise(r => {
                const reader = new FileReader();
                reader.onloadend = () => r(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });

            const checkResults = items.map((_, i) => document.getElementById('check_'+i).value);

            const payload = {
                email: document.getElementById('tEmail').value,
                name: document.getElementById('tName').value,
                time: document.getElementById('tTime').value,
                loc: document.getElementById('tLoc').value,
                memo: document.getElementById('tMemo').value,
                checks: checkResults, // 11項結果
                file: base64
            };

            const resp = await fetch(WEB_APP_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            });

            alert(await resp.text());
            location.reload();
        } catch(e) {
            alert("提交失敗: " + e.message);
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>
</body>
</html>
