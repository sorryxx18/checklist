<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>æ¶ˆé˜²è¨“ç·´å®‰å…¨æª¢æ ¸ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- å¤–éƒ¨è³‡æº -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root { --primary: #c0392b; --secondary: #2c3e50; --bg: #f5f6fa; }
    body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; }

    /* åˆ†é æ§åˆ¶ */
    .step-container { max-width: 800px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .step { display: none; }
    .step.active { display: block; }

    /* æ¨™é¡Œèˆ‡é€²åº¦ */
    .header { text-align: center; border-bottom: 2px solid var(--primary); margin-bottom: 20px; padding-bottom: 10px; }
    .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 0.85rem; color: #7f8c8d; }
    .progress-step { flex: 1; text-align: center; border-bottom: 3px solid #ddd; padding-bottom: 5px; }
    .progress-step.active { color: var(--primary); border-color: var(--primary); font-weight: bold; }

    /* è¡¨å–®å…ƒç´  */
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--secondary); }
    input[type="text"], input[type="datetime-local"], select, textarea {
      width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;
    }

    /* æª¢æ ¸è¡¨è¡¨æ ¼ */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
    th { background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; }
    td { padding: 10px; border: 1px solid #dee2e6; text-align: center; }
    .align-left { text-align: left; }

    /* ç°½åæ¿ */
    .sig-box { border: 2px dashed #bdc3c7; border-radius: 8px; margin-top: 10px; background: #fff; position: relative; }
    canvas { width: 100%; height: 180px; touch-action: none; }
    .sig-label { position: absolute; top: 5px; left: 10px; color: #bdc3c7; pointer-events: none; }

    /* æŒ‰éˆ• */
    .btn-group { display: flex; gap: 10px; margin-top: 25px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
    .btn-prev { background: #95a5a6; color: white; }
    .btn-next { background: var(--primary); color: white; }
    .btn-preview { background: #2980b9; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* é è¦½ Modalï¼ˆæ¡Œæ©Ÿç”¨ï¼‰ */
    #previewModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
    }
    .modal-content { background: white; width: 92%; height: 92%; border-radius: 10px; display: flex; flex-direction: column; }
    .modal-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    #pdfFrame { flex: 1; border: none; width: 100%; }

    /* loading */
    #loadingOverlay {
      display: none; position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.85); z-index: 2000; flex-direction: column; justify-content: center; align-items: center;
    }
  </style>
</head>

<body>
  <div id="loadingOverlay">
    <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i>
    <p id="loadingText" style="margin-top:15px; font-weight:bold;">è™•ç†ä¸­...</p>
  </div>

  <div class="step-container">
    <div class="header">
      <h2>è¨“ç·´å®‰å…¨æª¢æ ¸ç³»çµ±</h2>
    </div>

    <!-- é€²åº¦æ¢ -->
    <div class="progress-bar">
      <div class="progress-step active" id="p1">1. å¡«å¯«è³‡æ–™</div>
      <div class="progress-step" id="p2">2. æ•¸ä½ç°½ç« </div>
      <div class="progress-step" id="p3">3. é è¦½é€å‡º</div>
    </div>

    <!-- Step 1 -->
    <div class="step active" id="step1">
      <div class="form-group">
        <label>è¨“ç·´åç¨±</label>
        <input type="text" id="trainName" placeholder="ä¾‹å¦‚ï¼š113å¹´æ•‘åŠ©éšŠè¨“ç·´">
      </div>
      <div class="form-group">
        <label>æ—¥æœŸæ™‚é–“</label>
        <input type="datetime-local" id="trainTime">
      </div>
      <div class="form-group">
        <label>åœ°é»</label>
        <input type="text" id="trainLoc" placeholder="è¼¸å…¥è¨“ç·´å ´åœ°åç¨±">
      </div>
      <div class="form-group">
        <label>æ¥æ”¶é€šçŸ¥ Email</label>
        <input type="text" id="targetEmail" placeholder="æ”¶ä»¶äººä¿¡ç®± (ä¾‹å¦‚ï¼šboss@fire.gov.tw)">
      </div>

      <table>
        <thead>
          <tr>
            <th width="10%">é …æ¬¡</th>
            <th>å®‰å…¨æª¢æŸ¥æ³¨æ„äº‹é …</th>
            <th width="30%">ç¬¦åˆæƒ…å½¢</th>
          </tr>
        </thead>
        <tbody id="checklistTbody"></tbody>
      </table>

      <div class="btn-group">
        <button class="btn btn-next" onclick="nextStep(2)">
          ä¸‹ä¸€æ­¥ï¼šé€²è¡Œç°½å <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step" id="step2">
      <div class="form-group">
        <label>æ•™å®˜ç°½ç« </label>
        <div class="sig-box">
          <span class="sig-label">è«‹åœ¨æ­¤ç°½å</span>
          <canvas id="sigInst"></canvas>
        </div>
        <button onclick="sigInstPad.clear()" style="margin-top:5px;">é‡ç°½</button>
      </div>

      <div class="form-group" style="margin-top:30px;">
        <label>å®‰å…¨å®˜ç°½ç« </label>
        <div class="sig-box">
          <span class="sig-label">è«‹åœ¨æ­¤ç°½å</span>
          <canvas id="sigSafe"></canvas>
        </div>
        <button onclick="sigSafePad.clear()" style="margin-top:5px;">é‡ç°½</button>
      </div>

      <div class="btn-group">
        <button class="btn btn-prev" onclick="nextStep(1)">ä¸Šä¸€æ­¥</button>
        <button class="btn btn-next" onclick="nextStep(3)">
          ä¸‹ä¸€æ­¥ï¼šé è¦½/é€å‡º <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="step" id="step3">
      <div style="text-align: center; padding: 40px 0;">
        <i class="fas fa-file-pdf fa-5x" style="color: #e74c3c; margin-bottom: 20px;"></i>
        <p>è¡¨å–®å·²å¡«å¯«å®Œç•¢ï¼Œè«‹å…ˆé è¦½ PDF ç¢ºèªå…§å®¹ç„¡èª¤å¾Œå†è¡Œé€å‡ºã€‚</p>
        <p style="font-size:0.9rem; color:#7f8c8d; margin-top:8px;">ğŸ“± æ‰‹æ©Ÿæœƒä»¥ç³»çµ± PDF æª¢è¦–å™¨é–‹å•Ÿï¼ˆä¸èµ°å…§åµŒé è¦½ï¼‰</p>
      </div>

      <div class="btn-group">
        <button class="btn btn-prev" onclick="nextStep(2)">å›ä¸Šä¸€æ­¥ä¿®æ”¹</button>
        <button class="btn btn-preview" onclick="previewPDF()">é è¦½ PDF</button>
        <button class="btn btn-next" style="background:#27ae60;" onclick="finalSubmit()">
          ç¢ºèªå¯„é€ Email <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- PDF é è¦½è¦–çª—ï¼ˆæ¡Œæ©Ÿç”¨ï¼‰ -->
  <div id="previewModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0;">PDF é è¦½</h3>
        <button onclick="closePreview()" style="font-size:1.5rem; cursor:pointer; border:none; background:none;">&times;</button>
      </div>
      <iframe id="pdfFrame"></iframe>
    </div>
  </div>

  <script>
    // ====== è«‹æ”¹æˆä½ çš„ GAS Web App éƒ¨ç½²ç¶²å€ ======
    const GAS_URL = "ä½ çš„_GAS_ç¶²å€";

    const items = [
      "æ–¼è¨“ç·´å‰æ˜¯å¦æœ‰å°å­¸å“¡é€²è¡Œå±å®³å‘ŠçŸ¥?",
      "æ˜¯å¦ä¾ç…§æ¶ˆé˜²ç½²æˆ–å±€é ’æ•™æå…§å®¹å®‰æ’é€²è¡Œä¸Šèª²ã€‚",
      "æ˜¯å¦å·²ç†ŸçŸ¥ç½²é ’æ¶ˆé˜²å®‰å…¨æ•‘ç½æ‰‹å†Šå…§å®¹ä¹‹ç›¸é—œè¦å®šï¼Ÿ",
      "ç¾å ´æ“ä½œäººå“¡æœ‰ç„¡èº«é«”ä¸é©æƒ…å½¢ï¼Ÿé†«ç™‚å™¨ææœ‰ç„¡æº–å‚™ï¼Ÿ",
      "è©•ä¼°å¤©å€™ç‹€æ³æ˜¯å¦é©åˆæ“ä½œ?",
      "æ˜¯å¦é¸ç”¨é©ç•¶æ“ä½œå ´åŸŸ?",
      "å€‹äººè£å‚™åŠä½¿ç”¨å™¨ææ˜¯å¦é©ç•¶?",
      "è¨“ç·´æ‰€éœ€è£å‚™å™¨æå¤–è§€åŠŸèƒ½é»æª¢æ˜¯å¦æ­£å¸¸?",
      "ç¢ºèªæ“ä½œäººå“¡å€‹äººè£å‚™åŠèº«é«”ç‹€æ³",
      "æ•™å®˜æ˜¯å¦é€²è¡Œç¤ºç¯„è¬›è§£",
      "æ˜¯å¦æœ‰æ“¬å®šå®‰å…¨è¨ˆç•«(å‚™æ´æ–¹æ¡ˆ)ï¼Ÿ"
    ];

    let sigInstPad, sigSafePad;

    window.onload = () => {
      // æ¸²æŸ“è¡¨æ ¼
      const tbody = document.getElementById('checklistTbody');
      items.forEach((text, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${i+1}</td>
            <td class="align-left">${text}</td>
            <td>
              <select id="check_${i}">
                <option value="æ˜¯">æ˜¯ (Yes)</option>
                <option value="å¦">å¦ (No)</option>
                <option value="ä¸é©ç”¨">N/A</option>
              </select>
            </td>
          </tr>
        `;
      });

      // åˆå§‹åŒ–ç°½åæ¿
      const canvas1 = document.getElementById('sigInst');
      const canvas2 = document.getElementById('sigSafe');
      sigInstPad = new SignaturePad(canvas1);
      sigSafePad = new SignaturePad(canvas2);

      // é è¨­æ™‚é–“
      document.getElementById('trainTime').value = new Date().toISOString().slice(0, 16);

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
    };

    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      [document.getElementById('sigInst'), document.getElementById('sigSafe')].forEach(canvas => {
        if (!canvas) return;
        const w = canvas.offsetWidth;
        const h = canvas.offsetHeight;
        canvas.width = w * ratio;
        canvas.height = h * ratio;
        const ctx = canvas.getContext("2d");
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      });
    }

    function nextStep(stepNum) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.progress-step').forEach(p => p.classList.remove('active'));

      document.getElementById('step' + stepNum).classList.add('active');
      for (let i = 1; i <= stepNum; i++) document.getElementById('p' + i).classList.add('active');

      if (stepNum === 2) setTimeout(resizeCanvas, 100);
    }

    function validateStep1() {
      const name = document.getElementById('trainName').value.trim();
      const time = document.getElementById('trainTime').value.trim();
      const loc  = document.getElementById('trainLoc').value.trim();
      if (!name || !time || !loc) {
        alert("è«‹å…ˆå®Œæˆï¼šè¨“ç·´åç¨± / æ—¥æœŸæ™‚é–“ / åœ°é»");
        return false;
      }
      return true;
    }

    // ====== PDF ç”Ÿæˆ ======
    async function generatePDFBlob() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');

      // å»ºç«‹ PDF å…§å®¹ DOMï¼ˆè‡¨æ™‚æ’å…¥ï¼‰
      const printDiv = document.createElement('div');
      printDiv.style.cssText = "width:700px; padding:40px; background:white; color:black; font-family:'Microsoft JhengHei',sans-serif;";

      let tableHtml = "";
      items.forEach((text, i) => {
        const val = document.getElementById(`check_${i}`).value;
        tableHtml += `<tr>
          <td style="border:1px solid #000; padding:8px; text-align:center;">${i+1}</td>
          <td style="border:1px solid #000; padding:8px;">${text}</td>
          <td style="border:1px solid #000; padding:8px; text-align:center;">${val}</td>
        </tr>`;
      });

      const trainName = document.getElementById('trainName').value.trim();
      const trainTime = document.getElementById('trainTime').value.trim().replace('T', ' ');
      const trainLoc  = document.getElementById('trainLoc').value.trim();

      // ç°½åï¼ˆè‹¥æ²’ç°½åï¼Œé¿å…å ±éŒ¯ï¼‰
      const instSig = sigInstPad && !sigInstPad.isEmpty() ? sigInstPad.toDataURL() : "";
      const safeSig = sigSafePad && !sigSafePad.isEmpty() ? sigSafePad.toDataURL() : "";

      printDiv.innerHTML = `
        <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">
          <h1 style="margin:0;">è‡ºåŒ—å¸‚æ”¿åºœæ¶ˆé˜²å±€</h1>
          <h2 style="margin:5px 0;">è¨“ç·´å®‰å…¨æª¢æ ¸è¡¨ (é€šç”¨)</h2>
        </div>
        <div style="margin-top:20px;">
          <p><strong>è¨“ç·´åç¨±ï¼š</strong> ${escapeHtml(trainName)}</p>
          <p><strong>è¨“ç·´æ™‚é–“ï¼š</strong> ${escapeHtml(trainTime)}</p>
          <p><strong>è¨“ç·´åœ°é»ï¼š</strong> ${escapeHtml(trainLoc)}</p>
        </div>

        <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:14px;">
          <thead>
            <tr style="background:#eee;">
              <th style="border:1px solid #000; padding:8px;">é …æ¬¡</th>
              <th style="border:1px solid #000; padding:8px;">æª¢æŸ¥äº‹é …</th>
              <th style="border:1px solid #000; padding:8px;">çµæœ</th>
            </tr>
          </thead>
          <tbody>${tableHtml}</tbody>
        </table>

        <div style="margin-top:40px; display:flex; gap:20px;">
          <div style="flex:1;">
            <p>æ•™å®˜ç°½ç« ï¼š</p>
            ${instSig ? `<img src="${instSig}" style="width:180px; border-bottom:1px solid #000;">` : `<div style="height:60px; border-bottom:1px solid #000; width:180px;"></div>`}
          </div>
          <div style="flex:1;">
            <p>å®‰å…¨å®˜ç°½ç« ï¼š</p>
            ${safeSig ? `<img src="${safeSig}" style="width:180px; border-bottom:1px solid #000;">` : `<div style="height:60px; border-bottom:1px solid #000; width:180px;"></div>`}
          </div>
        </div>
      `;

      document.body.appendChild(printDiv);
      const canvas = await html2canvas(printDiv, { scale: 2, backgroundColor: "#ffffff" });
      document.body.removeChild(printDiv);

      const imgData = canvas.toDataURL('image/jpeg', 0.92);
      pdf.addImage(imgData, 'JPEG', 0, 0, 210, (canvas.height * 210) / canvas.width);

      return pdf.output('blob');
    }

    function escapeHtml(str) {
      return (str || "").replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    // ====== é è¦½ï¼ˆæ‰‹æ©Ÿï¼šå¤–é–‹ï¼›æ¡Œæ©Ÿï¼šmodal iframeï¼‰ ======
    async function previewPDF() {
      if (!validateStep1()) return;

      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingText').innerText = "æ­£åœ¨ç”Ÿæˆ PDF...";

      try {
        const blob = await generatePDFBlob();
        const url = URL.createObjectURL(blob);

        document.getElementById('loadingOverlay').style.display = 'none';

        if (isMobile()) {
          // âœ… æ‰‹æ©Ÿï¼šç›´æ¥å¤–é–‹ï¼ˆé¿å… iframe blob PDF å•é¡Œï¼‰
          window.open(url, "_blank");
          return;
        }

        // âœ… æ¡Œæ©Ÿï¼šå…§åµŒé è¦½
        document.getElementById('pdfFrame').src = url;
        document.getElementById('previewModal').style.display = 'flex';
      } catch (e) {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("é è¦½å¤±æ•—ï¼š" + e.message);
      }
    }

    function closePreview() {
      document.getElementById('previewModal').style.display = 'none';
      document.getElementById('pdfFrame').src = '';
    }

    // ====== å¯„é€ ======
    async function finalSubmit() {
      if (!validateStep1()) return;

      const email = document.getElementById('targetEmail').value.trim();
      if (!email) { alert("è«‹å¡«å¯«æ¥æ”¶é€šçŸ¥çš„ Email"); return; }
      if (!GAS_URL || GAS_URL.includes("ä½ çš„_GAS_ç¶²å€")) {
        alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š GAS_URLï¼ˆä½ çš„ GAS Web App éƒ¨ç½²ç¶²å€ï¼‰");
        return;
      }

      if (!confirm("ç¢ºå®šè¦ç”¢ç”Ÿ PDF ä¸¦å¯„é€ Email å—ï¼Ÿ")) return;

      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingText').innerText = "æ­£åœ¨ç”Ÿæˆ PDF ä¸¦å‚³é€è‡³ä¿¡ç®±...";

      try {
        const blob = await generatePDFBlob();
        const base64data = await blobToBase64(blob);

        const payload = {
          email: email,
          subject: "ã€å®‰å…¨æª¢æ ¸è¡¨ã€‘" + document.getElementById('trainName').value.trim(),
          fileName: "å®‰å…¨æª¢æ ¸è¡¨_" + new Date().getTime() + ".pdf",
          fileData: base64data,
          trainName: document.getElementById('trainName').value.trim(),
          trainTime: document.getElementById('trainTime').value.trim(),
          trainLoc: document.getElementById('trainLoc').value.trim()
        };

        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await response.text();
        document.getElementById('loadingOverlay').style.display = 'none';

        alert("å¯„é€å®Œæˆï¼\nå›æ‡‰ï¼š" + text);
        location.reload();
      } catch (e) {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert("å¯„é€å¤±æ•—ï¼š" + e.message);
      }
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const res = reader.result;
          const base64 = String(res).split(',')[1] || "";
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>