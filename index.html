<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>訓練安全檢核 (LIFF版)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* 沿用之前的 CSS 並針對手機優化 */
        :root { --primary: #d32f2f; --bg: #f8f9fa; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .step-container { max-width: 100%; margin: 0; background: white; padding: 15px; min-height: 100vh; }
        .header h2 { font-size: 1.4rem; color: var(--primary); text-align: center; margin: 10px 0; }
        
        .progress-bar { display: flex; margin-bottom: 20px; }
        .p-step { flex: 1; text-align: center; border-bottom: 3px solid #ddd; padding-bottom: 5px; font-size: 0.8rem; color: #aaa; }
        .p-step.active { color: var(--primary); border-color: var(--primary); font-weight: bold; }

        .step { display: none; }
        .step.active { display: block; }

        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        
        .sig-wrapper { border: 2px dashed #ccc; border-radius: 8px; margin-top: 10px; background: #fff; }
        canvas { width: 100%; height: 180px; touch-action: none; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; padding-bottom: 30px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .btn-gray { background: #999; }
        .btn-red { background: var(--primary); }
        
        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loader">
    <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i>
    <p>正在上傳數位檢核表...</p>
</div>

<div class="step-container">
    <div class="header">
        <h2>消防訓練安全檢核系統</h2>
    </div>

    <div class="progress-bar">
        <div class="p-step active" id="p1">1. 資料</div>
        <div class="p-step" id="p2">2. 檢核</div>
        <div class="p-step" id="p3">3. 簽名</div>
    </div>

    <!-- Step 1 -->
    <div class="step active" id="step1">
        <label>訓練名稱</label>
        <input type="text" id="tName" placeholder="例如：救助隊定期複訓">
        <label>日期時間</label>
        <input type="datetime-local" id="tTime">
        <label>地點</label>
        <input type="text" id="tLoc">
        <label>您的 LINE 姓名 (自動抓取)</label>
        <input type="text" id="userName" readonly style="background: #f0f0f0;">
        <label>接收通知 Email</label>
        <input type="email" id="tEmail" placeholder="收件人信箱">
        
        <div class="btn-group">
            <button class="btn btn-red" onclick="goStep(2)">下一步 <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <!-- Step 2 -->
    <div class="step" id="step2">
        <table>
            <tbody id="tableBody"></tbody>
        </table>
        <textarea id="tMemo" rows="3" placeholder="備註事項..." style="margin-top:15px;"></textarea>
        <div class="btn-group">
            <button class="btn btn-gray" onclick="goStep(1)">上一步</button>
            <button class="btn btn-red" onclick="goStep(3)">下一步</button>
        </div>
    </div>

    <!-- Step 3 -->
    <div class="step" id="step3">
        <p style="font-weight:bold;">教官簽章</p>
        <div class="sig-wrapper"><canvas id="cInst"></canvas></div>
        <p style="font-weight:bold; margin-top:20px;">安全官簽章</p>
        <div class="sig-wrapper"><canvas id="cSafe"></canvas></div>
        
        <div class="btn-group">
            <button class="btn btn-gray" onclick="goStep(2)">回上步</button>
            <button class="btn btn-red" onclick="finalSubmit()">確認送出歸檔</button>
        </div>
    </div>
</div>

<script>
    const LIFF_ID = "你的_LIFF_ID"; // ⚠️ 必須填入
    const WEB_APP_URL = "你的_GAS_網址"; 

    const items = ["危害告知", "教材內容", "救災手冊", "人員狀況", "天候狀況", "場域選擇", "裝備器材", "外觀點檢", "身體狀況", "教官示範", "安全計畫"];

    let pInst, pSafe;

    // LIFF 初始化
    async function initLiff() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                document.getElementById('userName').value = profile.displayName;
            }
        } catch (e) {
            console.error("LIFF 初始化失敗", e);
        }
    }

    window.onload = () => {
        const tbody = document.getElementById('tableBody');
        items.forEach((text, i) => {
            tbody.innerHTML += `<tr><td style="text-align:left">${i+1}. ${text}</td>
                <td width="80"><select id="check_${i}"><option value="是">是</option><option value="否">否</option></select></td></tr>`;
        });
        document.getElementById('tTime').value = new Date().toISOString().slice(0, 16);
        initLiff();
    };

    function initSign() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        [document.getElementById('cInst'), document.getElementById('cSafe')].forEach(canvas => {
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        });
        pInst = new SignaturePad(document.getElementById('cInst'));
        pSafe = new SignaturePad(document.getElementById('cSafe'));
    }

    function goStep(n) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.p-step').forEach(p => p.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        for(let i=1; i<=n; i++) document.getElementById('p'+i).classList.add('active');
        if (n === 3) setTimeout(initSign, 200);
    }

    async function finalSubmit() {
        if(pInst.isEmpty() || pSafe.isEmpty()) { alert("請完成雙方簽名"); return; }
        document.getElementById('loader').style.display = 'flex';
        
        try {
            // PDF 生成邏輯 (同前次) ...
            const base64 = "暫代_實際應放入PDF生成邏輯"; 

            const payload = {
                name: document.getElementById('tName').value,
                filler: document.getElementById('userName').value,
                file: base64
                // ... 其他欄位
            };

            await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });

            // LIFF 特有功能：在 LINE 聊天室發送訊息通知
            if (liff.isInClient()) {
                await liff.sendMessages([{
                    type: 'text',
                    text: `✅ 安全檢核已完成\n訓練：${payload.name}\n簽署人：${payload.filler}`
                }]);
            }

            alert("歸檔成功！視窗即將關閉。");
            liff.closeWindow(); // 關閉 LIFF 視窗
            
        } catch(e) {
            alert("提交失敗: " + e.message);
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>
</body>
</html>
